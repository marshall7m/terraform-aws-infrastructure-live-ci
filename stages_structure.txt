[for parent_path in var.stages : {
      name = "${stage.order == 1 ? stage.order + 1 : stage.order}-${stage.name}"
      actions = [ for path in var.paths if path in parent_path
        {
          name = "plan"
          category         = "Test"
          owner            = "AWS"
          provider         = "CodeBuild"
          version          = 1
          input_artifacts  = [var.branch]
          output_artifacts = ["${stage.name}-testing"]
          role_arn         = stage.tf_plan_role_arn
          configuration = {
            ProjectName = var.build_name
            EnvironmentVariables = "${jsonencode([
              {
                "name"  = "COMMAND"
                "value" = var.plan_cmd
                "type"  = "PLAINTEXT"
              },
              {
                "name"  = "PATH"
                "value" = stage.paths
                "type"  = "PLAINTEXT"
              }
            ])}"
          }
          run_order = 1
        },
        {
          name = "approval"
          category  = "Approval"
          owner     = "AWS"
          provider  = "Manual"
          version   = 1
          run_order = 2
        },
        {
          name = "apply"
          category         = "Build"
          owner            = "AWS"
          provider         = "CodeBuild"
          version          = 1
          input_artifacts  = [var.branch]
          output_artifacts = ["${stage.name}-apply"]
          role_arn         = stage.tf_apply_role_arn
          configuration = {
            ProjectName = var.build_name
            EnvironmentVariables = "${jsonencode([
              {
                "name"  = "COMMAND"
                "value" = var.apply_cmd
                "type"  = "PLAINTEXT"
              },
              {
                "name"  = "PATH"
                "value" = stage.paths
                "type"  = "PLAINTEXT"
              }
            ])}"
          }
          run_order = 3
        }
      ]
      }